#!/usr/bin/env python3
"""
ç®€å•çš„RAGåŒ¹é…ç»“æœéªŒè¯å·¥å…·
"""

def manual_verify():
    """æ‰‹åŠ¨éªŒè¯ä¹‹å‰çš„åŒ¹é…ç»“æœ"""
    
    print("ğŸ” æ‰‹åŠ¨éªŒè¯RAGåŒ¹é…ç»“æœ")
    print("=" * 50)
    
    # ä¹‹å‰çš„åŒ¹é…ç»“æœ
    match_result = {
        "page": 15,
        "bbox": [57.88999938964844, 30.45492935180664, 364.1160583496094, 544.4697265625],
        "similarity": 0.478,
        "match_type": "æ•´ä½“åŒºåŸŸåŒ¹é…"
    }
    
    # åŸå§‹åˆ‡ç‰‡å†…å®¹
    original_chunk = """
1ï¼‰å…ƒå™¨ä»¶å®‰è£…å­”ä¸å…ƒå™¨ä»¶å¼•çº¿ä¸åŒ¹é…# é—®é¢˜æè¿°å°åˆ¶æ¿å…ƒå™¨ä»¶å®‰è£…å­”å­”å¾„ä¸å…ƒå™¨ä»¶å¼•çº¿ç›´å¾„ä¸åŒ¹é…ï¼Œå¯¼è‡´å…ƒå™¨ä»¶å¼•çº¿æ— æ³•å®‰è£…æˆ–é—´éš™è¿‡å°ï¼Œå®¹æ˜“å¯¼è‡´å®‰è£…å­”æŸä¼¤æˆ–é€é”¡ä¸è‰¯ï¼Œå½±å“ç„Šç‚¹çš„å¯é æ€§ï¼Œè§å›¾1-1æ‰€ç¤ºã€‚  ç¼ºé™·æ¡ˆä¾‹ç…§ç‰‡ã€å›¾ç‰‡  ![](http://192.168.0.130:94/images/1e601365186a9748addcb8ab93f6d8fc753fa7a003dd8c02158656e8ddf28386.jpg)  å›¾1-1å…ƒå™¨ä»¶å¼•çº¿ç›´å¾„ä¸å°åˆ¶æ¿å…ƒå™¨ä»¶å®‰è£…å­”ç›´å¾„ é—´éš™è¿‡å°ï¼Œå®¹æ˜“æŸä¼¤å…ƒå™¨ä»¶å®‰è£…å­”ç¼ºé™·æ¡ˆä¾‹ç…§ç‰‡ã€å›¾ç‰‡![](http://192.168.0.130:94/images/1e601365186a9748addcb8ab93f6d8fc753fa7a003dd8c02158656e8ddf28386.jpg)# æ­£ç¡®æ–¹æ³•å°åˆ¶æ¿å…ƒå™¨ä»¶å®‰è£…å­”æˆå­”å…¬ç§°ç›´å¾„ä¸å…ƒå™¨ä»¶å¼•çº¿å…¬ç§°ç›´å¾„ä¹‹é—´åº”æœ‰ $0 . 2 { \sim } 0 . 4 ~ \mathrm { m m }$ çš„å¾„å‘é—´éš™ã€‚# ä¾æ®æ–‡ä»¶ã€æ ‡å‡†æˆ–è§„èŒƒQJ3012-98ç¬¬5.5.1èŠ‚è§„å®šï¼šå°åˆ¶æ¿å…ƒå™¨ä»¶å®‰è£…å­”å¾„ä¸å…ƒå™¨ä»¶å¼•çº¿ä¹‹é—´ï¼Œé‡‡ç”¨æ‰‹å·¥ç„Šæ¥å·¥è‰ºæ—¶åº”ä¿æŒ $0 . 2 \sim 0 . 4 ~ \mathrm { m m }$ çš„åˆç†é—´éš™ï¼Œé‡‡ç”¨æ³¢å³°ç„Šå·¥è‰ºæ—¶åº”ä¿æŒ $0 . 2 { \sim } 0 . 3 \ \mathrm { m m }$ çš„åˆç†é—´éš™ã€‚å½“å­”å¾„ä¸çº¿å¾„å¤±é…æ—¶ï¼Œä¸å…è®¸é‡‡å–æ‰©å­”å’Œä¿®é…çº¿å¾„çš„åŠæ³•ã€‚  QJ3013-99ç¬¬5.3.4.4èŠ‚è§„å®šï¼šå°åˆ¶æ¿é’»å­”å…¬ç§°ç›´å¾„ä¸å…ƒå™¨ä»¶å¼•çº¿å…¬ç§°ç›´å¾„çš„å·®å€¼å– $0 . 2 \sim 0 . 4 \ \mathrm { m m }$ ï¼Œå¯¹äºé‡‘å±åŒ–å­”ï¼Œå·®å€¼å–$0 . 3 { \sim } 0 . 4 ~ \mathrm { m m }$ ã€‚å¯¹äºçŸ©å½¢å¼•çº¿ï¼Œå¼•çº¿ç›´å¾„ä¸ºçŸ©å½¢æ¨ªæ¥é¢çš„å¯¹è§’çº¿ï¼Œå¹¶ä¸”å­”ä¸çŸ©å½¢å¼•çº¿çš„é—´éš™ä¸å¤§äºçŸ©å½¢å¼•çº¿åšåº¦æ–¹å‘å°ºå¯¸çš„ $0 . 7 ~ \mathrm { m m }$ ã€‚  GJB4057-2000ç¬¬6.4.1.2èŠ‚è§„å®šï¼šé•€è¦†å­”çš„ç›´å¾„åº”æ¯”å…ƒå™¨ä»¶å¼•çº¿çš„æœ€å¤§å°ºå¯¸å¤§ $0 . 2 { \sim } 0 . 4 ~ \mathrm { m m }$ ã€‚  $\operatorname { E C S S - Q - 7 0 - 0 8 A }$ ç¬¬8.4.2èŠ‚è§„å®šï¼šé•€é€šå­”ç›´å¾„æ¯”å…ƒå™¨ä»¶å¼•çº¿ç›´å¾„å¤§ $0 . 3 { \sim } 0 . 6 5 ~ \mathrm { m m }$ ã€‚å…ƒå™¨ä»¶éé•€é€šå­”çš„ç›´å¾„æ¯”å…ƒå™¨ä»¶å¼•çº¿ç›´å¾„æœ€å¤§ä¸åº”è¶…è¿‡ $0 . 2 ~ \mathrm { m m }$ ã€‚
    """
    
    print(f"ğŸ“„ åŒ¹é…é¡µç : {match_result['page']}")
    print(f"ğŸ“ åŒ¹é…åŒºåŸŸåæ ‡: {match_result['bbox']}")
    print(f"ğŸ“ åŒºåŸŸå¤§å°: {match_result['bbox'][2] - match_result['bbox'][0]:.0f} x {match_result['bbox'][3] - match_result['bbox'][1]:.0f} åƒç´ ")
    print(f"ğŸ“Š ç›¸ä¼¼åº¦: {match_result['similarity']:.3f} (47.8%)")
    
    # åˆ†æåŒ¹é…ç»“æœçš„åˆç†æ€§
    print(f"\nğŸ” åŒ¹é…ç»“æœåˆ†æ:")
    
    # 1. é¡µç åˆ†æ
    print(f"   ğŸ“– é¡µç  {match_result['page']} - åˆç†ï¼Œåœ¨PDFä¸­é—´éƒ¨åˆ†")
    
    # 2. åŒºåŸŸå¤§å°åˆ†æ
    width = match_result['bbox'][2] - match_result['bbox'][0]
    height = match_result['bbox'][3] - match_result['bbox'][1]
    print(f"   ğŸ“ åŒºåŸŸå¤§å° {width:.0f}x{height:.0f} - {'å¤§å‹åŒºåŸŸï¼Œå¯èƒ½åŒ…å«å®Œæ•´å†…å®¹' if height > 400 else 'ä¸­ç­‰åŒºåŸŸ'}")
    
    # 3. ç›¸ä¼¼åº¦åˆ†æ
    similarity = match_result['similarity']
    if similarity >= 0.6:
        similarity_status = "é«˜ç›¸ä¼¼åº¦ï¼ŒåŒ¹é…è‰¯å¥½"
    elif similarity >= 0.4:
        similarity_status = "ä¸­ç­‰ç›¸ä¼¼åº¦ï¼Œéƒ¨åˆ†åŒ¹é…"
    else:
        similarity_status = "ä½ç›¸ä¼¼åº¦ï¼Œå¯èƒ½åŒ¹é…ä¸å‡†ç¡®"
    
    print(f"   ğŸ“Š ç›¸ä¼¼åº¦ {similarity:.3f} - {similarity_status}")
    
    # 4. å†…å®¹ç‰¹å¾åˆ†æ
    chunk_keywords = ["å…ƒå™¨ä»¶", "å®‰è£…å­”", "å¼•çº¿", "ç›´å¾„", "é—´éš™", "å°åˆ¶æ¿", "QJ3012", "GJB4057"]
    print(f"   ğŸ”¤ å…³é”®ç‰¹å¾è¯: {', '.join(chunk_keywords[:5])}")
    
    print(f"\nâœ… éªŒè¯å»ºè®®:")
    print(f"   1. æ‰“å¼€PDFç¬¬{match_result['page']}é¡µ")
    print(f"   2. æŸ¥çœ‹åæ ‡åŒºåŸŸ ({match_result['bbox'][0]:.0f}, {match_result['bbox'][1]:.0f}) åˆ° ({match_result['bbox'][2]:.0f}, {match_result['bbox'][3]:.0f})")
    print(f"   3. ç¡®è®¤è¯¥åŒºåŸŸæ˜¯å¦åŒ…å«å…³é”®è¯: {', '.join(chunk_keywords[:3])}")
    print(f"   4. æ£€æŸ¥æ˜¯å¦æœ‰å›¾è¡¨ 'å›¾1-1' å’Œæ ‡å‡†ç¼–å· 'QJ3012-98'")
    
    # ç®€å•çš„æå–éªŒè¯ï¼ˆå¦‚æœå¯èƒ½ï¼‰
    try:
        import pymupdf as fitz
        
        pdf_path = "data/èˆªå¤©ç”µå­äº§å“å¸¸è§è´¨é‡ç¼ºé™·æ¡ˆä¾‹.13610530(2).pdf"
        print(f"\nğŸ” å°è¯•æå–åŒ¹é…åŒºåŸŸæ–‡æœ¬...")
        
        doc = fitz.open(pdf_path)
        page = doc[match_result['page'] - 1]  # è½¬ä¸º0ç´¢å¼•
        
        # æå–åŒ¹é…åŒºåŸŸæ–‡æœ¬
        rect = fitz.Rect(match_result['bbox'])
        extracted_text = page.get_textbox(rect)
        
        print(f"ğŸ“ æå–çš„æ–‡æœ¬é¢„è§ˆ (å‰200å­—ç¬¦):")
        print("-" * 30)
        print(extracted_text[:200])
        print("-" * 30)
        
        # ç®€å•å…³é”®è¯æ£€æŸ¥
        found_keywords = []
        for keyword in chunk_keywords:
            if keyword in extracted_text:
                found_keywords.append(keyword)
        
        print(f"âœ… æ‰¾åˆ°çš„å…³é”®è¯: {found_keywords}")
        print(f"ğŸ“Š å…³é”®è¯åŒ¹é…ç‡: {len(found_keywords)}/{len(chunk_keywords)} ({len(found_keywords)/len(chunk_keywords)*100:.1f}%)")
        
        doc.close()
        
        # æœ€ç»ˆéªŒè¯ç»“è®º
        if len(found_keywords) >= len(chunk_keywords) * 0.5:
            print(f"\nğŸ‰ éªŒè¯ç»“æœ: âœ… åŒ¹é…æœ‰æ•ˆ")
            print(f"   æ‰¾åˆ°äº†è¶³å¤Ÿçš„å…³é”®è¯ï¼Œå®šä½ç»“æœå¯ä¿¡")
        else:
            print(f"\nâš ï¸  éªŒè¯ç»“æœ: â“ åŒ¹é…å¯ç–‘")
            print(f"   å…³é”®è¯åŒ¹é…ä¸è¶³ï¼Œå»ºè®®æ£€æŸ¥")
            
    except Exception as e:
        print(f"\nğŸ’¡ æ— æ³•è‡ªåŠ¨æå–æ–‡æœ¬éªŒè¯: {e}")
        print(f"   è¯·æ‰‹åŠ¨æ‰“å¼€PDFç¬¬{match_result['page']}é¡µéªŒè¯")

if __name__ == "__main__":
    manual_verify() 