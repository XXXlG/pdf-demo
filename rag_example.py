#!/usr/bin/env python3
"""
RAGçŸ¥è¯†åˆ‡ç‰‡åæ ‡å®šä½ä½¿ç”¨ç¤ºä¾‹ - ä¼˜åŒ–ç‰ˆ
æ¼”ç¤ºå¦‚ä½•ç²¾ç¡®å®šä½å•ä¸ªçŸ¥è¯†åˆ‡ç‰‡åœ¨PDFä¸­çš„ä½ç½®
"""

from rag_chunk_locator import find_rag_chunk_coordinates, analyze_chunk_content

def simple_example():
    """ç®€å•ä½¿ç”¨ç¤ºä¾‹ - è¿”å›æœ€ä½³åŒ¹é…"""
    
    # æ¨¡æ‹ŸRAGç³»ç»Ÿä¸­çš„çŸ¥è¯†åˆ‡ç‰‡
    knowledge_chunk = r"""
6ï¼‰å¤§é¢ç§¯è¦†é“œåŒºåŸŸçš„å…ƒå™¨ä»¶å®‰è£…å­”è®¾è®¡ç¼ºé™·# é—®é¢˜æè¿°å¤§é¢ç§¯è¦†é“œåŒºåŸŸä¸Šçš„ç„Šç›˜è®¾è®¡æ²¡æœ‰åšå‡ºéš”ç¦»èš€åˆ»åŒºåŸŸè¿›è¡Œçƒ­éš”ç¦»ï¼Œä¼šå¯¼è‡´æ•£çƒ­è¿‡å¿«ï¼Œå®¹æ˜“å½¢æˆé€é”¡ä¸è‰¯çš„ç„Šç‚¹ï¼Œè§å›¾1-8æ‰€ç¤ºã€‚  ![](http://192.168.0.130:94/images/cf8ddd7b7217ef5ef02edb7843a682e6a1d58e6d735607e9968bd37c7d53f24f.jpg)  ç¼ºé™·æ¡ˆä¾‹ç…§ç‰‡ã€å›¾ç‰‡  å›¾1-8å¤§é¢ç§¯è¦†é“œåŒºåŸŸä¸Šçš„ç„Šç›˜è®¾è®¡ç¼ºé™·ç¼ºé™·æ¡ˆä¾‹ç…§ç‰‡ã€å›¾ç‰‡![](http://192.168.0.130:94/images/cf8ddd7b7217ef5ef02edb7843a682e6a1d58e6d735607e9968bd37c7d53f24f.jpg)![](http://192.168.0.130:94/images/fd2e47626fa542aa7ea38cb59a973e31e8771007654d1169d1bcf48b97e4ab2a.jpg)![](http://192.168.0.130:94/images/79a775c251e1c684eca88831d5e12bf777e51b53e0404003ec88c1124553c1ef.jpg)# æ­£ç¡®æ–¹æ³•éœ€è¦ç„Šæ¥çš„éƒ¨åˆ†å°½é‡é¿å…å¸ƒè®¾è¶…è¿‡ $6 ~ \mathrm { c m } ^ { 2 }$ çš„å¯¼ç”µé¢ç§¯ï¼Œå¦‚æœå¤§çš„å¯¼ç”µé¢ç§¯ä¸Šæœ‰ç„Šç‚¹ï¼Œå…¶ç„Šæ¥éƒ¨ä½åº”åœ¨ä¿æŒå…¶å¯¼ä½“è¿ç»­æ€§çš„åŸºç¡€ä¸Šï¼Œåšå‡ºéš”ç¦»èš€åˆ»åŒºåŸŸä»¥è¿›è¡Œçƒ­éš”ç¦»ã€‚ç„Šæ¥å¯æ“ä½œæ€§çš„æ’åˆ—é¡ºåºä¸€èˆ¬ä¸ºï¼šç„Šç›˜é€šè¿‡éš”çƒ­å¯¼çº¿è¿æ¥åˆ°åœ°å±‚ã€èŠ±ç„Šç›˜ä¸ç½‘æ ¼çŠ¶åœ°ç›¸è¿ã€èŠ±ç„Šç›˜ä¸å®èŠ¯åœ°å±‚ç›¸è¿ã€ç„Šç›˜ç›´æ¥ä¸å®èŠ¯åœ°å±‚ç›¸è¿ã€‚# ä¾æ®æ–‡ä»¶ã€æ ‡å‡†æˆ–è§„èŒƒQJ3013A-2011ç¬¬5.6.2.3èŠ‚è§„å®šï¼šå¯¹å°åˆ¶æ¿è¡¨é¢è¾ƒå¤§çš„å¯¼ç”µé¢ç§¯ï¼ˆå¤§äº $2 5 ~ \mathrm { m m } \times 2 5 ~ \mathrm { m m }$ ï¼‰åº”é‡‡ç”¨ç½‘æ ¼å¼çš„çª—å£ï¼Œä»¥å‡å°‘ç„Šæ¥è¿‡ç¨‹ä¸­å¯¹çƒ­é‡çš„å¸æ”¶ï¼›å¦‚æœæœ‰ç„Šç›˜ï¼Œåº”è¿›è¡Œçƒ­éš”ç¦»ï¼Œå¹¶ä¿æŒç”µæ°”è¿æ¥ï¼Œå¯ä»¥é¿å…å¤§çš„å¯¼ç”µé¢ç§¯åœ¨ç„Šæ¥æ—¶å› çƒ­é‡ç§¯ç´¯è€Œèµ·æ³¡ï¼›å¤šå±‚å°åˆ¶æ¿å†…å±‚åœ°ã€ç”µå±‚é“œç®”é¢ä¸Šå¦‚æœæœ‰è¿æ¥ç›˜ï¼Œä¹Ÿåº”è¿›è¡Œçƒ­éš”ç¦»ï¼›åœ¨ç„Šæ¥æ—¶å‡å°‘æ•£çƒ­é€Ÿåº¦ï¼Œä½¿çƒ­é‡é›†ä¸­åœ¨ç„Šç›˜ä¸Šï¼Œä»¥æœ‰åˆ©äºç„Šæ¥ã€‚ä½†ä½œä¸ºå¾®å¸¦çº¿å’Œå¸¦çŠ¶çº¿çš„é•œåƒæ¥åœ°é¢ï¼Œä¸èƒ½å¼€ç½‘æ ¼å¼çš„çª—å£ï¼Œä»¥å…å¼•èµ·å¯¼çº¿ç‰¹æ€§é˜»æŠ—çš„å˜åŒ–ã€‚çƒ­éš”ç¦»ç„Šç›˜è§å›¾1-9æ‰€ç¤ºã€‚  ![](http://192.168.0.130:94/images/fd2e47626fa542aa7ea38cb59a973e31e8771007654d1169d1bcf48b97e4ab2a.jpg)  å›¾1-9å¤§å¯¼ç”µé¢ç§¯çš„æ•£çƒ­çª—å£å’Œéš”çƒ­ç„Šç›˜è®¾è®¡  GJB4057-2000ç¬¬6.4.3èŠ‚è§„å®šï¼šå¯¹äºå¤§äº $5 \times 5 ~ \mathrm { m m } ^ { 2 }$ çš„å¤§é¢ç§¯å¯¼ç”µå›¾å½¢ï¼Œåº”å±€éƒ¨å¼€çª—å£ï¼›ç”µæºå±‚ã€åœ°å±‚å¤§é¢ç§¯å›¾å½¢ä¸å…¶è¿æ¥ç›˜ä¹‹é—´åº”è¿›è¡Œçƒ­éš”ç¦»è®¾è®¡ï¼Œå¦‚å›¾1-10æ‰€ç¤ºã€‚  ![](http://192.168.0.130:94/images/79a775c251e1c684eca88831d5e12bf777e51b53e0404003ec88c1124553c1ef.jpg)  å›¾1-10ç”µæºå±‚ã€åœ°å±‚çƒ­éš”ç¦»
    """
    
    # PDFæ–‡ä»¶è·¯å¾„
    pdf_file = "data/èˆªå¤©ç”µå­äº§å“å¸¸è§è´¨é‡ç¼ºé™·æ¡ˆä¾‹.13610530(2).pdf"
    
    print("RAGçŸ¥è¯†åˆ‡ç‰‡ç²¾ç¡®å®šä½ç¤ºä¾‹")
    print("=" * 50)
    
    # 1. åˆ†æåˆ‡ç‰‡å†…å®¹
    print("1. åˆ†æçŸ¥è¯†åˆ‡ç‰‡...")
    analysis = analyze_chunk_content(knowledge_chunk)
    
    print(f"åˆ‡ç‰‡é•¿åº¦: {analysis['length']} å­—ç¬¦")
    print(f"å¥å­æ•°é‡: {analysis['sentences']}")
    print(f"åŒ…å«æ•°å­—: {analysis['has_numbers']}")
    print(f"å¤æ‚åº¦è¯„åˆ†: {analysis['complexity_score']:.2f}")
    
    # 2. å®šä½åˆ‡ç‰‡åœ¨PDFä¸­çš„ä½ç½®ï¼ˆåªè¿”å›æœ€ä½³åŒ¹é…ï¼‰
    print("\n2. å®šä½åˆ‡ç‰‡æœ€ä½³ä½ç½®...")
    try:
        results = find_rag_chunk_coordinates(
            knowledge_chunk, 
            pdf_file,
            similarity_threshold=0.3,  # å¯ä»¥è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼
            return_best_only=True     # åªè¿”å›æœ€ä½³åŒ¹é…
        )
        
        if results:
            result = results[0]  # åªæœ‰ä¸€ä¸ªæœ€ä½³ç»“æœ
            print("âœ… æ‰¾åˆ°æœ€ä½³åŒ¹é…ä½ç½®:")
            print(f"   ğŸ“„ é¡µç : {result['page']}")
            print(f"   ğŸ“ åæ ‡: {result['bbox']}")  # [x0, y0, x1, y1]
            print(f"   ğŸ¯ åŒ¹é…ç±»å‹: {result['match_type']}")
            print(f"   ğŸ“Š ç›¸ä¼¼åº¦: {result['similarity']:.3f}")
            
            # æ˜¾ç¤ºåŒ¹é…çš„æ–‡æœ¬é¢„è§ˆ
            if 'found_text' in result:
                preview = result['found_text'][:200] + "..." if len(result['found_text']) > 200 else result['found_text']
                print(f"   ğŸ“ åŒ¹é…æ–‡æœ¬é¢„è§ˆ: {preview}")
            
            print(f"\nğŸ‰ åˆ‡ç‰‡å·²æˆåŠŸå®šä½åˆ°ç¬¬ {result['page']} é¡µçš„åæ ‡ {result['bbox']}")
            
        else:
            print("âŒ æœªæ‰¾åˆ°åŒ¹é…ä½ç½®")
            print("ğŸ’¡ å»ºè®®: å°è¯•é™ä½ç›¸ä¼¼åº¦é˜ˆå€¼æˆ–æ£€æŸ¥åˆ‡ç‰‡å†…å®¹")
        
    except FileNotFoundError:
        print(f"âŒ æ‰¾ä¸åˆ°PDFæ–‡ä»¶: {pdf_file}")
        print("ğŸ’¡ è¯·ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®")
    except Exception as e:
        print(f"âŒ å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")


def advanced_example():
    """é«˜çº§ç¤ºä¾‹ - å±•ç¤ºå¤šç§åŒ¹é…é€‰é¡¹"""
    
    # è¾ƒçŸ­çš„çŸ¥è¯†åˆ‡ç‰‡
    short_chunk = "å…ƒå™¨ä»¶å®‰è£…å­”ä¸å…ƒå™¨ä»¶å¼•çº¿ä¸åŒ¹é…ï¼Œå¯¼è‡´å…ƒå™¨ä»¶å¼•çº¿æ— æ³•å®‰è£…æˆ–é—´éš™è¿‡å°ï¼Œå®¹æ˜“å¯¼è‡´å®‰è£…å­”æŸä¼¤ã€‚"
    
    pdf_file = "data/èˆªå¤©ç”µå­äº§å“å¸¸è§è´¨é‡ç¼ºé™·æ¡ˆä¾‹.13610530(2).pdf"
    
    print("\né«˜çº§åŒ¹é…ç¤ºä¾‹")
    print("=" * 30)
    
    # æ¯”è¾ƒä¸åŒé˜ˆå€¼çš„æ•ˆæœ
    thresholds = [0.3, 0.5, 0.7]
    
    for threshold in thresholds:
        print(f"\nğŸ“Š ç›¸ä¼¼åº¦é˜ˆå€¼: {threshold}")
        
        try:
            # è¿”å›æ‰€æœ‰å€™é€‰åŒ¹é…
            results = find_rag_chunk_coordinates(
                short_chunk, 
                pdf_file,
                similarity_threshold=threshold,
                return_best_only=False  # è¿”å›æ‰€æœ‰åŒ¹é…
            )
            
            print(f"   æ‰¾åˆ° {len(results)} ä¸ªåŒ¹é…åŒºåŸŸ")
            
            for i, result in enumerate(results[:3], 1):  # åªæ˜¾ç¤ºå‰3ä¸ª
                print(f"   {i}. é¡µ{result['page']} | ç›¸ä¼¼åº¦: {result['similarity']:.3f} | ç±»å‹: {result.get('match_type', 'N/A')}")
                
        except Exception as e:
            print(f"   âŒ é”™è¯¯: {e}")


def test_with_custom_chunk():
    """æµ‹è¯•è‡ªå®šä¹‰åˆ‡ç‰‡"""
    
    # ç”¨æˆ·å¯ä»¥æ›¿æ¢è¿™é‡Œçš„å†…å®¹
    custom_chunk = input("\nè¯·è¾“å…¥è¦å®šä½çš„çŸ¥è¯†åˆ‡ç‰‡å†…å®¹ (æˆ–ç›´æ¥å›è½¦ä½¿ç”¨é»˜è®¤): ").strip()
    
    if not custom_chunk:
        custom_chunk = "å°åˆ¶æ¿å…ƒå™¨ä»¶å®‰è£…å­”æˆå­”å…¬ç§°ç›´å¾„ä¸å…ƒå™¨ä»¶å¼•çº¿å…¬ç§°ç›´å¾„ä¹‹é—´åº”æœ‰åˆç†é—´éš™"
    
    pdf_file = "data/èˆªå¤©ç”µå­äº§å“å¸¸è§è´¨é‡ç¼ºé™·æ¡ˆä¾‹.13610530(2).pdf"
    
    print(f"\nğŸ” æ­£åœ¨å®šä½: {custom_chunk[:50]}...")
    
    try:
        results = find_rag_chunk_coordinates(
            custom_chunk, 
            pdf_file,
            similarity_threshold=0.4,  # ç¨å¾®å®½æ¾çš„é˜ˆå€¼
            return_best_only=True
        )
        
        if results:
            result = results[0]
            print(f"âœ… å®šä½æˆåŠŸ!")
            print(f"   é¡µç : {result['page']}")
            print(f"   åæ ‡: {result['bbox']}")
            print(f"   ç›¸ä¼¼åº¦: {result['similarity']:.3f}")
        else:
            print("âŒ æœªæ‰¾åˆ°åŒ¹é…ä½ç½®")
            
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")


if __name__ == "__main__":
    # è¿è¡ŒåŸºæœ¬ç¤ºä¾‹
    simple_example()
    
    # è¿è¡Œé«˜çº§ç¤ºä¾‹
    advanced_example()
    
    # äº¤äº’å¼æµ‹è¯•
    test_with_custom_chunk() 